<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elderly Care Backend Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <div class="max-w-4xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800">ðŸ‘µ Elderly Care Backend Tester</h1>
            <p class="text-gray-600 mt-2">A simple interface to test all endpoints of your FastAPI application.</p>
        </header>

        <!-- Configuration Section -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Configuration</h2>
            <div class="space-y-4">
                <div>
                    <label for="base-url" class="block text-sm font-medium text-gray-700">Backend Base URL</label>
                    <input type="text" id="base-url" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" value="https://elderly-care-backend-8216020119.us-central1.run.app">
                </div>
                <div>
                    <label for="user-id" class="block text-sm font-medium text-gray-700">User ID</label>
                    <input type="text" id="user-id" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500" placeholder="e.g., R1, U002, etc.">
                </div>
            </div>
        </div>

        <!-- Main Request Flow -->
        <div class="bg-white p-6 rounded-xl shadow-md">
            <div id="initial-request-section">
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">1. Initial Voice Request</h2>
                <p class="text-sm text-gray-600 mb-4">This panel tests the <code>POST /request/voice</code> endpoint. Upload a .wav file to begin.</p>
                <div class="space-y-4">
                    <div>
                        <label for="audio-file-initial" class="block text-sm font-medium text-gray-700">Audio File (.wav)</label>
                        <input type="file" id="audio-file-initial" accept=".wav,audio/wav" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100">
                    </div>
                    <button id="submit-initial" class="w-full bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 12L3 8m4 8l4-8m4 8V4m0 12h4m-4-1l-4-8m0 0l-4 8m4-8l4 8"></path></svg>
                        Send Initial Request
                    </button>
                </div>
            </div>

            <!-- Continuation Request Flow (hidden by default) -->
            <div id="continue-request-section" class="hidden mt-8 pt-6 border-t border-dashed">
                 <h2 class="text-xl font-bold text-gray-800 mb-2">2. Follow-up Request</h2>
                 <p id="clarification-prompt" class="text-sm text-center bg-yellow-100 text-yellow-800 rounded-lg p-3 mb-4"></p>
                <div class="space-y-4">
                    <div>
                        <label for="audio-file-continue" class="block text-sm font-medium text-gray-700">Follow-up Audio File (.wav)</label>
                        <input type="file" id="audio-file-continue" accept=".wav,audio/wav" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100">
                    </div>
                    <button id="submit-continue" class="w-full bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                        Send Follow-up Response
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Admin Section -->
        <div class="bg-white p-6 rounded-xl shadow-md mt-8">
             <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Admin Actions</h2>
             <p class="text-sm text-gray-600 mb-4">This tests the <code>DELETE /request/last</code> endpoint. Use with caution.</p>
             <button id="delete-last" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 flex items-center justify-center">
                 <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                Delete Last Request
             </button>
        </div>


        <!-- Response Section -->
        <div class="bg-white p-6 rounded-xl shadow-md mt-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Server Response</h2>
            <div id="response-container" class="bg-gray-900 text-white text-sm rounded-lg p-4 h-64 overflow-y-auto">
                <div id="loading-spinner" class="hidden h-full flex items-center justify-center flex-col">
                    <div class="spinner w-12 h-12 rounded-full border-4 border-gray-600"></div>
                    <p class="mt-4 text-gray-400">Communicating with server...</p>
                </div>
                <pre id="response-output" class="whitespace-pre-wrap break-words">Awaiting request...</pre>
            </div>
        </div>
    </div>

    <script>
        const baseUrlInput = document.getElementById('base-url');
        const userIdInput = document.getElementById('user-id');
        
        const initialRequestSection = document.getElementById('initial-request-section');
        const initialFileInput = document.getElementById('audio-file-initial');
        const submitInitialBtn = document.getElementById('submit-initial');

        const continueRequestSection = document.getElementById('continue-request-section');
        const clarificationPrompt = document.getElementById('clarification-prompt');
        const continueFileInput = document.getElementById('audio-file-continue');
        const submitContinueBtn = document.getElementById('submit-continue');
        
        const deleteLastBtn = document.getElementById('delete-last');

        const responseContainer = document.getElementById('response-container');
        const responseOutput = document.getElementById('response-output');
        const loadingSpinner = document.getElementById('loading-spinner');

        let pendingRequestId = null;

        // Function to show loading state
        function showLoading() {
            responseOutput.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
        }

        // Function to hide loading state and show response
        function showResponse(data, status, ok) {
            loadingSpinner.classList.add('hidden');
            responseOutput.classList.remove('hidden');
            
            const color = ok ? 'text-green-400' : 'text-red-400';
            responseOutput.innerHTML = `<p class="font-bold ${color} mb-2">Status: ${status}</p>${JSON.stringify(data, null, 2)}`;
        }

        // Handle the initial voice request
        submitInitialBtn.addEventListener('click', async () => {
            const userId = userIdInput.value;
            const audioFile = initialFileInput.files[0];
            const baseUrl = baseUrlInput.value;

            if (!userId || !audioFile) {
                alert('Please provide a User ID and select an audio file.');
                return;
            }

            const formData = new FormData();
            formData.append('audio_file', audioFile);

            showLoading();
            
            try {
                const response = await fetch(`${baseUrl}/request/voice?user_id=${userId}`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                showResponse(data, response.status, response.ok);

                if (response.ok && data.status === 'incomplete') {
                    pendingRequestId = data.pending_request_id;
                    clarificationPrompt.textContent = data.clarification_prompt_text;
                    continueRequestSection.classList.remove('hidden');
                    initialRequestSection.classList.add('opacity-50', 'pointer-events-none');
                } else {
                    // Reset on success or other final states
                    pendingRequestId = null;
                    continueRequestSection.classList.add('hidden');
                    initialRequestSection.classList.remove('opacity-50', 'pointer-events-none');
                }

            } catch (error) {
                showResponse({ error: 'Network or server error', details: error.message }, 'CLIENT_ERROR', false);
            }
        });

        // Handle the continuation voice request
        submitContinueBtn.addEventListener('click', async () => {
            const userId = userIdInput.value;
            const audioFile = continueFileInput.files[0];
            const baseUrl = baseUrlInput.value;

            if (!userId || !audioFile || !pendingRequestId) {
                alert('A User ID, a new audio file, and a pending request are required.');
                return;
            }

            const formData = new FormData();
            formData.append('audio_file', audioFile);

            showLoading();

            try {
                const response = await fetch(`${baseUrl}/request/voice/continue?user_id=${userId}&pending_request_id=${pendingRequestId}`, {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json();
                showResponse(data, response.status, response.ok);
                
                // If it's still incomplete, just update the prompt.
                if (response.ok && data.status === 'incomplete') {
                     clarificationPrompt.textContent = data.clarification_prompt_text;
                     pendingRequestId = data.pending_request_id;
                } else {
                    // If it's a success or any other final state, reset the whole UI.
                    pendingRequestId = null;
                    continueRequestSection.classList.add('hidden');
                    initialRequestSection.classList.remove('opacity-50', 'pointer-events-none');
                    initialFileInput.value = '';
                    continueFileInput.value = '';
                }

            } catch (error) {
                showResponse({ error: 'Network or server error', details: error.message }, 'CLIENT_ERROR', false);
            }
        });
        
        // Handle deleting the last request
        deleteLastBtn.addEventListener('click', async () => {
            if (!confirm('Are you sure you want to delete the last request? This cannot be undone.')) {
                return;
            }
            
            const baseUrl = baseUrlInput.value;
            showLoading();
            
            try {
                const response = await fetch(`${baseUrl}/request/last`, {
                    method: 'DELETE',
                });
                
                const data = await response.json();
                showResponse(data, response.status, response.ok);

            } catch (error) {
                 showResponse({ error: 'Network or server error', details: error.message }, 'CLIENT_ERROR', false);
            }
        });

    </script>
</body>
</html>
